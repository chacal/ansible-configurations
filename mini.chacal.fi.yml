---
#
# This playbook is used to provision Mini after fresh Proxmox installation
# Assumptions:
#  - Passwordless SSH connection with "root"
#

- hosts: all
  remote_user: root
  gather_facts: yes

  vars_files:
    - secrets.yml

  vars:

  handlers:
    - name: Update boot parameters
      command: pve-efiboot-tool refresh

  roles:

  tasks:
    - name: Enable IOMMU & serial console
      copy:
        dest: /etc/kernel/cmdline
        content: root=ZFS=rpool/ROOT/pve-1 boot=zfs intel_iommu=on
      notify: Update boot parameters

    - name: Add PVE admin user
      include_role:
        name: pve_admin_user
      vars:
        pve_admin_username: pve_admin
        pve_admin_pw_hash: "{{ chacal.mini.proxmox_user_pw_hash }}"
      tags: pve_admin_user

    - name: Setup networks
      copy:
        dest: /etc/network/interfaces
        content: |
          # network interface settings; autogenerated
          # Please do NOT modify this file directly, unless you know what
          # you're doing.
          #
          # If you want to manage parts of the network configuration manually,
          # please utilize the 'source' or 'source-directory' directives to do
          # so.
          # PVE will preserve these directives, but will NOT read its network
          # configuration from sourced files, so do not attempt to move any of
          # the PVE managed interfaces into external files!
          auto lo
          iface lo inet loopback

          auto vmbr0
          iface vmbr0 inet manual
              bridge-ports enp2s0
              bridge-stp off
              bridge-fd 0
          # eth0, WAN
          
          auto vmbr1
          iface vmbr1 inet manual
              bridge-ports enp3s0
              bridge-stp off
              bridge-fd 0
          # eth1, LAN
          
          auto vmbr2
          iface vmbr2 inet manual
              bridge-ports enp4s0
              bridge-stp off
              bridge-fd 0
          # eth2, OPT1
          
          auto enp5s0         
          iface enp5s0 inet static
              address 10.50.99.7/24
              gateway 10.50.99.1
              dns-nameservers 10.50.99.1
          # eth3, MGMT
      tags: networking
